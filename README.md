# Evidence spanner Source Plugin

Install this plugin in an Evidence app with
```bash
npm install evidence-connector-spanner
```

Register the plugin in your project in your evidence.plugins.yaml file with
```bash
datasources:
  evidence-connector-spanner: {}
```

Launch the development server with `npm run dev` and navigate to the settings menu [localhost:3000/settings](http://localhost:3000/settings) to add a data source using this plugin.

Notes:
- https://www.npmjs.com/package/@google-cloud/spanner
- file-bases-evidence connector
- add ref to advanced-connector
- https://docs.evidence.dev/plugins/create-source-plugin/#promoting-your-plugin
- check TODO's
- write tests (incl. integration tests using emulator)
- create verification pipeline
- create release pipeline
- write README
- publish to npm https://github.com/LeonStoldt/evidence-connector-spanner?tab=readme-ov-file#publishing-to-npm
- make use of nvm (+direnv?)



---
# Docs (TODO)

### Spanner

Evidence supports connecting to Google Cloud Spanner by using:
- gcloud CLI
- [service account](https://cloud.google.com/iam/docs/service-accounts) and a JSON key
- OAuth access token
- or [cloud-spanner-emulator](https://cloud.google.com/spanner/docs/emulator).

#### Logging in with the gcloud CLI

If you have the [gcloud CLI](https://cloud.google.com/sdk/gcloud) installed, you can log in to Spanner using the following command:

```bash
gcloud auth application-default login
```

Evidence will use the credentials stored by the gcloud CLI to connect to Spanner.

> *Note: Since gcloud requires browser access, this method is only available when developing locally.*

#### Create a Service Account Key

1. [Go to the Service Account Page](https://console.cloud.google.com/projectselector/iam-admin/serviceaccounts/create?supportedpurview=project) and click on your project
2. Add a name for your service account, then click `Create`
3. Assign your service account a role for Spanner (scroll down the role dropdown to find Spanner roles).
   1. **Spanner User** should work for most use cases.
   1. **Spanner Data Viewer** may be required (depending on your organization's permissions settings in Google Cloud).
4. Click `Continue`, then click `Done`. You should see a table of users.
5. Click on the email address for the service account you just created, then click the **Keys** tab
6. Click `Add Key`, then `Create New Key`, then `Create`
7. Google will download a JSON Key File to your computer

#### Logging in with an OAuth access token

If you have an access token but can't download the gcloud CLI on the device you're deploying on and don't want to use a service account, you can use an OAuth access token.

An OAuth access token can be generated by running the following command on a device with the gcloud CLI installed:

```bash
gcloud auth application-default print-access-token
```
> *Note: This token will expire after 1 hour.*

Now you can copy the access token and use it in your Evidence project.

#### Using a Cloud Spanner Emulator

TODO...

> *Note: Since gcloud requires browser access, this method is only available when developing locally.*
